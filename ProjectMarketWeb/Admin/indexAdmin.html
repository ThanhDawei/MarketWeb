<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>DMarket</title>
    <link rel="stylesheet" href="../css/styles.css" />
    <link rel="stylesheet" href="../css/admin-styles.css" />
    <link rel="stylesheet" href="../css/all.css" />
    <script>
      (function () {
        // === KHÓA LOCALSTORAGE ===
        const STORAGE_KEY = "userAccounts";
        const INVOICES_KEY = "invoices";
        const IMPORT_RECEIPTS_KEY = "importReceipts";
        const PRODUCTS_KEY = "products"; // Dùng để xóa dữ liệu cũ

        // === DỮ LIỆU NGƯỜI DÙNG MẪU (THÊM 1 USER) ===
        const mockUsers = [
          {
            username: "khachhangA",
            password: "123",
            phone: "0909123456",
            address: "123 Đường ABC, Phường 1, Quận 1, TP. HCM",
            locked: false,
          },
          {
            username: "khachhangB",
            password: "123",
            phone: "0909789012",
            address: "456 Đường XYZ, Phường Tân Phong, Quận 7, TP. HCM",
            locked: false,
          },
          {
            username: "nguoidungC",
            password: "123",
            phone: "0988111222",
            address: "789 Đường LMN, Phường 5, Quận 3, TP. HCM",
            locked: false,
          },
        ];

        // === DỮ LIỆU PHIẾU NHẬP MẪU (GIỮ NGUYÊN) ===
        const mockReceipts = [
          {
            id: "1700000001",
            date: "15/11/2025, 09:00:00", // (Ngày này không quan trọng)
            importedBy: "Admin",
            status: "Hoàn thành",
            items: [
              // (Chứa tất cả 19 sản phẩm...)
              {
                productName: "Laptop Dell XPS 13 9340",
                quantity: 30,
                price: 30000000,
                category: "Laptop",
              },
              {
                productName: "Apple Watch Series 9 45mm",
                quantity: 50,
                price: 9000000,
                category: "Đồng hồ thông minh",
              },
              {
                productName: "RAM Corsair Vengeance RGB 32GB (2x16GB) DDR5",
                quantity: 40,
                price: 4000000,
                category: "Linh kiện PC",
              },
              {
                productName: "iPad Pro 12.9 inch M2 256GB",
                quantity: 20,
                price: 25000000,
                category: "Máy tính bảng",
              },
              {
                productName: "Apple AirPods Pro 2 (USB-C)",
                quantity: 60,
                price: 5000000,
                category: "Tai nghe",
              },
              {
                productName: "Sạc dự phòng Anker 20000mAh",
                quantity: 100,
                price: 800000,
                category: "Phụ kiện",
              },
              {
                productName: "Cáp Belkin USB-C to Lightning",
                quantity: 150,
                price: 300000,
                category: "Phụ kiện",
              },
              {
                productName: "Gimbal DJI Osmo Mobile 6",
                quantity: 30,
                price: 3000000,
                category: "Phụ kiện",
              },
              {
                productName: "iPhone 15 Pro Max 256GB",
                quantity: 40,
                price: 28000000,
                category: "Điện thoại",
              },
              {
                productName: "Ổ cứng WD My Passport 2TB",
                quantity: 50,
                price: 1500000,
                category: "Phụ kiện lưu trữ",
              },
              {
                productName: "Router TP-Link Archer AX73",
                quantity: 30,
                price: 2000000,
                category: "Thiết bị mạng",
              },
              {
                productName: "Tai nghe Sony WH-1000XM5",
                quantity: 25,
                price: 7000000,
                category: "Tai nghe",
              },
              {
                productName: "Samsung Galaxy Tab S9",
                quantity: 20,
                price: 18000000,
                category: "Máy tính bảng",
              },
              {
                productName: "Samsung Galaxy Watch 6",
                quantity: 50,
                price: 5500000,
                category: "Đồng hồ thông minh",
              },
              {
                productName: "SSD Samsung 990 PRO 1TB",
                quantity: 30,
                price: 3500000,
                category: "Linh kiện máy tính",
              },
              {
                productName: "Ốp lưng iPhone 15 Pro",
                quantity: 200,
                price: 250000,
                category: "Phụ kiện điện thoại",
              },
              {
                productName: "MacBook Air M3",
                quantity: 25,
                price: 27000000,
                category: "Laptop",
              },
              {
                productName: "MacBook Pro 14 M3",
                quantity: 15,
                price: 38000000,
                category: "Laptop",
              },
              {
                productName: "Chuột Logitech MX Master 3S",
                quantity: 70,
                price: 2000000,
                category: "Phụ kiện máy tính",
              },
            ],
          },
        ];

        // === DỮ LIỆU HÓA ĐƠN MỚI (2020 - 2024) ===
        const mockInvoices = [
          {
            id: 1584246600, // 2020
            date: "15/03/2020, 10:30:00",
            user: "khachhangA",
            items: [
              {
                name: "Cáp Belkin USB-C to Lightning",
                quantity: 2,
                price: 360000,
              },
              {
                name: "Sạc dự phòng Anker 20000mAh",
                quantity: 1,
                price: 960000,
              },
            ],
            total: 1680000,
            status: "Đã giao",
          },
          {
            id: 1621519200, // 2021
            date: "20/05/2021, 14:00:00",
            user: "khachhangB",
            items: [
              { name: "Gimbal DJI Osmo Mobile 6", quantity: 1, price: 3600000 },
            ],
            total: 3600000,
            status: "Đã giao",
          },
          {
            id: 1640970000, // 2022
            date: "01/01/2022, 12:00:00",
            user: "khachhangA",
            items: [
              {
                name: "RAM Corsair Vengeance RGB 32GB (2x16GB) DDR5",
                quantity: 1,
                price: 4800000,
              },
              { name: "SSD Samsung 990 PRO 1TB", quantity: 1, price: 4200000 },
            ],
            total: 9000000,
            status: "Đã giao",
          },
          {
            id: 1694308500, // 2023
            date: "10/09/2023, 09:15:00",
            user: "nguoidungC",
            items: [
              { name: "Laptop Dell XPS 13 9340", quantity: 1, price: 36000000 },
            ],
            total: 36000000,
            status: "Đã giao",
          },
          {
            id: 1703533500, // 2023
            date: "25/12/2023, 19:45:00",
            user: "khachhangB",
            items: [
              {
                name: "Apple Watch Series 9 45mm",
                quantity: 1,
                price: 10800000,
              },
              {
                name: "Apple AirPods Pro 2 (USB-C)",
                quantity: 1,
                price: 6000000,
              },
            ],
            total: 16800000,
            status: "Đã giao",
          },
          {
            id: 1707107400, // 2024
            date: "05/02/2024, 11:30:00",
            user: "khachhangA",
            items: [
              { name: "iPhone 15 Pro Max 256GB", quantity: 1, price: 33600000 },
              { name: "Ốp lưng iPhone 15 Pro", quantity: 2, price: 300000 },
            ],
            total: 34200000,
            status: "Đang vận chuyển",
          },
          {
            id: 1721206800, // 2024
            date: "17/07/2024, 16:00:00",
            user: "nguoidungC",
            items: [
              { name: "MacBook Air M3", quantity: 1, price: 32400000 },
              {
                name: "Chuột Logitech MX Master 3S",
                quantity: 1,
                price: 2400000,
              },
            ],
            total: 34800000,
            status: "Đã hủy",
          },
        ];

        // === NẠP DỮ LIỆU VÀO LOCALSTORAGE ===
        // (Luôn xóa dữ liệu cũ để đảm bảo tính nhất quán)

        localStorage.removeItem(PRODUCTS_KEY); // Xóa 'products' cũ để 'syncInventoryToShelf' chạy lại
        localStorage.setItem(STORAGE_KEY, JSON.stringify(mockUsers));
        localStorage.setItem(IMPORT_RECEIPTS_KEY, JSON.stringify(mockReceipts));
        localStorage.setItem(INVOICES_KEY, JSON.stringify(mockInvoices));

        console.log(
          "Đã nạp dữ liệu mẫu MỚI (Users, Receipts, Invoices 2020-2024)."
        );
      })();
    </script>
    <script src="managerScript.js"></script>
    <script src="../User/UserScript.js"></script>
  </head>
  <body>
    <div id="loginContainer" class="login-container">
      <div class="login-box">
        <div class="login-header">
          <i class="fa-solid fa-shield-halved"></i>
          <h1>Admin Panel</h1>
          <p>Đăng nhập để quản lý hệ thống</p>
        </div>

        <div id="errorMessage" class="error-message"></div>

        <form id="loginForm">
          <div class="form-group">
            <label for="username">
              <i class="fa-solid fa-user"></i> Tên đăng nhập
            </label>
            <input
              type="text"
              id="username"
              placeholder="Nhập tên đăng nhập"
              required
              autocomplete="username"
            />
          </div>

          <div class="form-group">
            <label for="password">
              <i class="fa-solid fa-lock"></i> Mật khẩu
            </label>
            <input
              type="password"
              id="password"
              placeholder="Nhập mật khẩu"
              required
              autocomplete="current-password"
            />
          </div>

          <button type="submit" class="login-btn">
            <i class="fa-solid fa-right-to-bracket"></i> Đăng nhập
          </button>
        </form>
      </div>
    </div>

    <admin id="adminPanel" class="admin-panel">
      <div class="container">
        <div class="sidebar">
          <h1>Admin</h1>
          <button id="manageUserBtn" type="button">
            <div class="box">
              <h1><i class="fa-solid fa-users"></i> Quản lý khách hàng</h1>
            </div>
          </button>
          <button id="manageProductBtn" type="button">
            <div class="box">
              <h1><i class="fa-solid fa-shop"></i> Quản lý sản phẩm</h1>
            </div>
          </button>
          <button id="manageProfitBtn" type="button">
            <div class="box">
              <h1><i class="fa-solid fa-chart-line"></i> Quản lý Lợi nhuận</h1>
            </div>
          </button>
          <button id="manageInvoiceBtn" type="button">
            <div class="box">
              <h1>
                <i class="fa-solid fa-file-invoice-dollar"></i> Quản lý hóa đơn
              </h1>
            </div>
          </button>
          <button id="manageStockBtn" type="button">
            <div class="box">
              <h1><i class="fa-solid fa-warehouse"></i> Quản lý kho</h1>
            </div>
          </button>
          <button id="addInfoBtn" type="button">
            <div class="box">
              <h1><i class="fa-solid fa-table"></i> Phiếu nhập hàng</h1>
            </div>
          </button>
          <button id="logoutBtn" type="button">
            <div class="box">
              <h1><i class="fa-solid fa-right-from-bracket"></i> Đăng xuất</h1>
            </div>
          </button>
        </div>

        <div class="content">
          <div id="userContent" class="manageUser" style="display: none"></div>
          <div
            id="productContent"
            class="manageProduct"
            style="display: none"
          ></div>
          <div
            id="profitContent"
            class="content-section"
            style="display: none"
          ></div>
          <div
            id="invoiceContent"
            class="manageInvoice"
            style="display: none"
          ></div>
          <div id="addInfoContent" class="addInfo" style="display: none"></div>
          <div id="stockContent" class="content-section" style="display: none">
            <div class="management-header">
              <h2><i class="fa-solid fa-warehouse"></i> Quản lý Kho Hàng</h2>
            </div>
            <div class="table-container">
              <table class="admin-table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Tên sản phẩm</th>
                    <th>Danh mục</th>
                    <th>Số lượng tồn kho</th>
                    <th>Thao tác</th>
                  </tr>
                </thead>
                <tbody id="stockTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div id="product-form-popup" class="popup" style="display: none">
          <div class="popup-content">
            <span id="close-product-form-popup" class="close">&times;</span>
            <h2>Thêm / Sửa sản phẩm</h2>
            <form id="productForm">
              <div style="margin-bottom: 15px">
                <label
                  style="display: block; margin-bottom: 5px; font-weight: 600"
                >
                  Tên sản phẩm:
                </label>
                <input
                  type="text"
                  id="name"
                  placeholder="Nhập tên sản phẩm..."
                  style="
                    width: 100%;
                    padding: 10px;
                    border: 2px solid #e0e0e0;
                    border-radius: 8px;
                    outline: none;
                  "
                  required
                />
              </div>

              <div style="margin-bottom: 15px">
                <label
                  style="display: block; margin-bottom: 5px; font-weight: 600"
                >
                  Giá bán (đ):
                </label>
                <input
                  type="number"
                  id="value"
                  min="0"
                  step="1"
                  placeholder="Nhập giá bán"
                  style="
                    width: 100%;
                    padding: 10px;
                    border: 2px solid #e0e0e0;
                    border-radius: 8px;
                    outline: none;
                  "
                  required
                />
                <div
                  id="valueReadOnlyNote"
                  class="admin-field-hint"
                  style="display: none"
                >
                  Giá bán được quản lý tại mục
                  <strong>Quản lý Lợi nhuận</strong>.
                </div>
              </div>

              <div style="margin-bottom: 15px">
                <label
                  style="display: block; margin-bottom: 5px; font-weight: 600"
                >
                  Số lượng (trên kệ):
                </label>
                <input
                  type="number"
                  id="quantity"
                  min="0"
                  step="1"
                  placeholder="Nhập số lượng"
                  style="
                    width: 100%;
                    padding: 10px;
                    border: 2px solid #e0e0e0;
                    border-radius: 8px;
                    outline: none;
                  "
                  required
                />
                <div
                  id="quantityAvailableNote"
                  class="admin-field-hint"
                  style="display: none"
                ></div>
              </div>

              <div style="margin-bottom: 15px">
                <label
                  style="display: block; margin-bottom: 5px; font-weight: 600"
                >
                  Mô tả sản phẩm:
                </label>
                <textarea
                  id="description"
                  rows="4"
                  style="
                    width: 100%;
                    padding: 10px;
                    border: 2px solid #e0e0e0;
                    border-radius: 8px;
                    outline: none;
                  "
                  placeholder="Nhập mô tả chi tiết..."
                ></textarea>
              </div>

              <div style="margin-bottom: 15px">
                <label
                  style="display: block; margin-bottom: 5px; font-weight: 600"
                >
                  Thông số kỹ thuật:
                </label>
                <textarea
                  id="specs"
                  rows="4"
                  style="
                    width: 100%;
                    padding: 10px;
                    border: 2px solid #e0e0e0;
                    border-radius: 8px;
                    outline: none;
                  "
                  placeholder="Ví dụ: RAM: 8GB, Màn hình: 6.5 inch..."
                ></textarea>
              </div>

              <input type="file" id="image" accept="image/*" />
              <button type="submit">Lưu</button>
            </form>
          </div>
        </div>
      </div>
    </admin>

    <script>
      // Xử lý đăng nhập
      document.addEventListener("DOMContentLoaded", () => {
        const loginForm = document.getElementById("loginForm");
        const loginContainer = document.getElementById("loginContainer");
        const adminPanel = document.getElementById("adminPanel");
        const errorMessage = document.getElementById("errorMessage");
        const logoutBtn = document.getElementById("logoutBtn");

        // Tài khoản admin mặc định (có thể lưu trong localStorage)
        const ADMIN_ACCOUNTS = [
          { username: "admin", password: "admin123" },
          { username: "quantri", password: "123456" },
        ];

        // Kiểm tra trạng thái đăng nhập
        function checkLoginStatus() {
          const isLoggedIn = sessionStorage.getItem("adminLoggedIn");
          const loginTime = sessionStorage.getItem("adminLoginTime");

          // Kiểm tra session timeout (30 phút)
          if (isLoggedIn === "true" && loginTime) {
            const currentTime = new Date().getTime();
            const timeDiff = currentTime - parseInt(loginTime);
            const thirtyMinutes = 30 * 60 * 1000;

            if (timeDiff > thirtyMinutes) {
              // Session hết hạn
              logout();
              showError("Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.");
              return false;
            }

            // Đăng nhập hợp lệ
            showAdminPanel();
            return true;
          }

          return false;
        }

        // Hiển thị thông báo lỗi
        function showError(message) {
          errorMessage.textContent = message;
          errorMessage.classList.add("show");
          setTimeout(() => {
            errorMessage.classList.remove("show");
          }, 3000);
        }

        // Hiển thị Admin Panel
        function showAdminPanel() {
          loginContainer.style.display = "none";
          adminPanel.style.display = "block";
          localStorage.setItem("isAdmin", "true");
        }

        // Xử lý đăng nhập
        loginForm.addEventListener("submit", (e) => {
          e.preventDefault();

          const username = document.getElementById("username").value.trim();
          const password = document.getElementById("password").value.trim();

          // Kiểm tra tài khoản
          const validAccount = ADMIN_ACCOUNTS.find(
            (acc) => acc.username === username && acc.password === password
          );

          if (validAccount) {
            // Đăng nhập thành công
            sessionStorage.setItem("adminLoggedIn", "true");
            sessionStorage.setItem("adminLoginTime", new Date().getTime());
            sessionStorage.setItem("adminUsername", username);

            showAdminPanel();

            // Reset form
            loginForm.reset();
          } else {
            // Đăng nhập thất bại
            showError("Tên đăng nhập hoặc mật khẩu không đúng!");
          }
        });

        // Xử lý đăng xuất
        function logout() {
          sessionStorage.removeItem("adminLoggedIn");
          sessionStorage.removeItem("adminLoginTime");
          sessionStorage.removeItem("adminUsername");
          localStorage.removeItem("isAdmin");

          loginContainer.style.display = "flex";
          adminPanel.style.display = "none";
          loginForm.reset();
        }

        logoutBtn.addEventListener("click", () => {
          if (confirm("Bạn có chắc muốn đăng xuất?")) {
            logout();
          }
        });

        // Kiểm tra session mỗi phút
        setInterval(() => {
          const isLoggedIn = sessionStorage.getItem("adminLoggedIn");
          if (isLoggedIn === "true") {
            checkLoginStatus();
          }
        }, 60000); // 1 phút

        // Kiểm tra trạng thái đăng nhập khi tải trang
        checkLoginStatus();
      });
    </script>
  </body>
</html>
